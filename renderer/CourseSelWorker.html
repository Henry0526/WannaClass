<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Course Window</title>
</head>

<body>
    <script>
        const { ipcRenderer } = require("electron");
        const { default: Axios } = require("axios")
        var sqlite3 = require('sqlite3').verbose();
        const path = require("path");

        var TODAYYEAR = new Date().getFullYear() - 1911;
        var TODAYSMT = new Date().getMonth() >= 7 ? 1 : 2;
        const { BackendService } = require("./js/yzu_backend");
        var apibackend = new BackendService()

        var tasks = [];

        // const database = new Database("db.sqlite");
        const database = new sqlite3.Database('db.sqlite');





        /** 
         * 
         * 
        */

        function insertTaskList(course) {
            database.run(`INSERT INTO 
            tasks(year, smtr, stage, cos_id, cos_class, cos_type_name, credit, room, name, teacher_name, dept_name)
            VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
                [course["year"], course["smtr"], "1", course["cos_id"], course["cos_class"], course["cos_type_name"], course["credit"], course["room"], course["name"], course["teacher_name"], course["dept_name"]],
                function (err) {
                    if (err) {
                        return console.log(err.message);
                    }
                    // get the last insert id
                    console.log(`A row has been inserted with rowid ${this.lastID}`);
                });
        }

        // // 被通知又有一個 Schedule 加入
        ipcRenderer.on("addTaskCourse", (event, data) => {
            console.log(data);
            insertTaskList(data)
        })
        /*
            WeekandRoom: "307(2621),308(2621),309(2621),"
            cd_prompt: null
            ci_prompt: "服務類課程、品質類課程"
            cos_class: "A "
            cos_id: "IE376 "
            cos_type_name: "選修"
            credit: 3
            dept_name: "工業工程與管理學系學士班"
            hashid: "ea9aa758f6b5dbdbbb8a7116e53d3619"
            name: "醫療品質管理"
            room: "2621"
            smtr: "2"
            teacher_id: "houtai38"
            teacher_name: "張厚台"
            time: "307,308,309"
            year: "109"
        */





        window.onload = function () {

            console.log("CREATE TABLE IF NOT EXISTS");
            database.run(
                `CREATE TABLE IF NOT EXISTS  tasks (
                    "id" INTEGER PRIMARY KEY AUTOINCREMENT, 
                    "year" TEXT,
                    "smtr" TEXT,
                    "stage" TEXT,
                    "cos_id" TEXT,
                    "cos_class" TEXT,
                    "cos_type_name" TEXT,
                    "credit" INTEGER,
                    "room" TEXT,
                    "name" TEXT,
                    "teacher_name" TEXT,
                    "dept_name" TEXT
                    );`
            );
            console.log("SELECT ALL");

            database.all(`SELECT * FROM tasks`, [], (err, rows) => {
                if (err) {
                    throw err;
                }
                rows.forEach((row) => {
                    console.log(row);
                    tasks.push(row);
                });


                setInterval(getCourses, 3000)


            });
        }

        
        function getCourses(){
            tasks.forEach((element)=>{

                apibackend.selCourseInline(element).then((res)=>{
                    console.log(res);
                })
                
            })
        }



    </script>
</body>

</html>